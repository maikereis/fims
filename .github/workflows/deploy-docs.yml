name: Deploy API Documentation

on:
    push:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: "pages"
    cancel-in-progress: false

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: maven

            - name: Build with Maven
              run: mvn clean install -DskipTests

            - name: Generate JavaDoc
              run: mvn javadoc:javadoc

            - name: Start Spring Boot app
              env:
                  JWT_SECRET: ${{ secrets.JWT_SECRET }}
              run: |
                  mvn spring-boot:start -Dspring-boot.run.arguments="--server.port=8080 --spring.profiles.active=doc"
                  echo "Waiting for app to start..."
                  timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; do sleep 2; done'

            - name: Generate OpenAPI spec
              run: |
                  curl http://localhost:8080/v3/api-docs -o openapi.json
                  curl http://localhost:8080/v3/api-docs.yaml -o openapi.yaml

            - name: Stop Spring Boot app
              run: mvn spring-boot:stop

            - name: Create docs directory
              run: |
                  mkdir -p docs/javadoc
                  cp -r target/site/apidocs/* docs/javadoc/
                  mv openapi.json docs/
                  mv openapi.yaml docs/

            - name: Create Swagger UI page
              run: |
                  cat > docs/index.html << 'EOF'
                  <!DOCTYPE html>
                  <html lang="en">
                  <head>
                      <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0">
                      <title>FIMS API Documentation</title>
                      <style>
                          body {
                              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                              margin: 0;
                              padding: 0;
                              background: #f5f5f5;
                          }
                          .header {
                              background: #1a1a1a;
                              color: white;
                              padding: 2rem;
                              text-align: center;
                          }
                          .nav {
                              display: flex;
                              justify-content: center;
                              gap: 1rem;
                              padding: 1rem;
                              background: white;
                              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                          }
                          .nav a {
                              padding: 0.5rem 1rem;
                              text-decoration: none;
                              color: #333;
                              border-radius: 4px;
                              transition: background 0.3s;
                          }
                          .nav a:hover {
                              background: #e0e0e0;
                          }
                          iframe {
                              width: 100%;
                              height: calc(100vh - 180px);
                              border: none;
                          }
                      </style>
                  </head>
                  <body>
                      <div class="header">
                          <h1>FIMS - Field Inspection Management System</h1>
                          <p>API Documentation</p>
                      </div>
                      <div class="nav">
                          <a href="swagger.html">API Reference (Swagger)</a>
                          <a href="javadoc/index.html">JavaDoc</a>
                          <a href="openapi.json" download>Download OpenAPI JSON</a>
                          <a href="openapi.yaml" download>Download OpenAPI YAML</a>
                      </div>
                      <iframe src="swagger.html"></iframe>
                  </body>
                  </html>
                  EOF

            - name: Create Swagger page
              run: |
                  cat > docs/swagger.html << 'EOF'
                  <!DOCTYPE html>
                  <html lang="en">
                  <head>
                      <meta charset="UTF-8">
                      <title>FIMS API - Swagger UI</title>
                      <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5/swagger-ui.css">
                      <style>
                          body { margin: 0; }
                          .swagger-ui .topbar { display: none; }
                      </style>
                  </head>
                  <body>
                      <div id="swagger-ui"></div>
                      <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js"></script>
                      <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-standalone-preset.js"></script>
                      <script>
                          window.onload = () => {
                              SwaggerUIBundle({
                                  url: './openapi.json',
                                  dom_id: '#swagger-ui',
                                  deepLinking: true,
                                  presets: [
                                      SwaggerUIBundle.presets.apis,
                                      SwaggerUIStandalonePreset
                                  ],
                                  plugins: [
                                      SwaggerUIBundle.plugins.DownloadUrl
                                  ],
                                  layout: "BaseLayout"
                              });
                          };
                      </script>
                  </body>
                  </html>
                  EOF

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./docs

    deploy:
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
